pipeline {
  agent any

  environment {
    APP_NAME = "spring-app"
    IMAGE_TAG = "latest"
    MYSQL_CONTAINER = "mysql-prod"
    MYSQL_IMAGE = "mysql:8.0"
    MYSQL_PORT = "3306"
    MYSQL_DB = "taro" 
    MYSQL_USER = "taro"
    MYSQL_PASSWORD = "taro1234"
  }

  stages {
    stage('Checkout') {
      steps {
        git branch: 'back', url: 'https://lab.ssafy.com/s13-ai-image-sub1/S13P21A601.git'
      }
    }

    stage('Build Docker Image') {
      steps {
        sh """
          docker build -t ${APP_NAME}:${IMAGE_TAG} .
        """
      }
    }

    stage('Start MySQL') {
      steps {
        sh """
          docker rm -f ${MYSQL_CONTAINER} || true
          docker run -d --name ${MYSQL_CONTAINER} \
            -e MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD} \
            -e MYSQL_DATABASE=${MYSQL_DB} \
            -e MYSQL_USER=${MYSQL_USER} \
            -e MYSQL_PASSWORD=${MYSQL_PASSWORD} \
            -p ${MYSQL_PORT}:3306 \
            ${MYSQL_IMAGE}
        """
      }
    }

    stage('Deploy Spring App') {
      steps {
        sh """
          docker rm -f ${APP_NAME}-dev || true
          docker run -d --name ${APP_NAME}-dev \
            -p 8080:8080 \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://${MYSQL_CONTAINER}:${MYSQL_PORT}/${MYSQL_DB} \
            -e SPRING_DATASOURCE_USERNAME=${MYSQL_USER} \
            -e SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD} \
            --network bridge \
            ${APP_NAME}:${IMAGE_TAG}
        """
      }
    }
  }
}